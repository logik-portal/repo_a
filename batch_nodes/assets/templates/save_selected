# Batch Nodes - Save Selected Node
# Copyright (c) 2025 Michael Vaglienty
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.
#
# License:       GNU General Public License v3.0 (GPL-3.0)
#                https://www.gnu.org/licenses/gpl-3.0.en.html

"""
Script Name: Batch Nodes - Node Menu
Script Version: 3.10.0
Flame Version: 2023.2
Written by: Michael Vaglienty
Creation Date: 04.18.20
Update Date: 04.04.25

License: GNU General Public License v3.0 (GPL-3.0) - see LICENSE file for details

Script Type: Batch

Description:

    Batch right-click menu script for <NodeName> node. This script was created by Batch Nodes script.

Menu:

    Right-click in batch -> Batch Nodes... -> <NodeName>

Updates:

    v3.10.0 04.04.25
        - Updated to PyFlameLib v4.3.0.

    v3.9.0 01.04.25
        - Updated to PyFlameLib v4.0.0.
        - Script now only works with Flame 2023.2+.

    v3.8.0 08.09.24
        - Updated to PyFlameLib v3.
"""

import flame
from pyflame_lib_batch_nodes import *

def create_node():

    # Create node
    new_node = flame.batch.create_node('<NodeType>')
    new_node.load_node_setup('<NodeSetupPathName>')
    new_node_name = '<NodeName>'

    # Check for duplicate node name
    # If duplicate found and number until not duplicate
    node_list = []

    for item in flame.batch.nodes:
        item_name = str(item.name)[1:-1]
        node_list.append(item_name)

    x = 1

    orig_node_name = new_node_name

    while new_node_name in node_list:
        new_node_name = orig_node_name
        new_node_name = new_node_name + str(x)
        x += 1

    new_node.name = new_node_name

    return new_node

def create_connected_node(selected_node):

    new_node = create_node()

    #  Attach new node to selected node
    new_node.pos_x = selected_node.pos_x + 300
    new_node.pos_y = selected_node.pos_y
    flame.batch.connect_nodes(selected_node, 'Default', new_node, 'Default')

    pyflame.print('Node Created: <NodeName>', text_color=TextColor.GREEN)

def create_free_node():

    new_node = create_node()

    # Position new node under cursor
    cursor_pos = flame.batch.cursor_position
    new_node.pos_x = cursor_pos[0]
    new_node.pos_y = cursor_pos[1]

    pyflame.print('Node Created: <NodeName>', text_color=TextColor.GREEN)

def scope_node(selection):

    pyflame.print_title(f'Batch Nodes - <NodeName> <Version>')

    if selection == ():
        create_free_node()
    else:
        for n in selection:
            if isinstance(n, flame.PyNode):
                create_connected_node(n)

def get_batch_custom_ui_actions():

    return [
        {
            'name': 'Batch Nodes...',
            'actions': [
                {
                    'name': '<NodeName>',
                    'execute': scope_node,
                    'minimumVersion': '2023.2'
                }
            ]
        }
    ]
